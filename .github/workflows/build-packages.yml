# .github/workflows/build-packages.yml
name: Build Python Packages for Multiple Environments

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      packages:
        description: 'è¦ä¸‹è½½çš„åŒ…åˆ—è¡¨ (ç”¨ç©ºæ ¼åˆ†éš”)'
        required: false
        default: 'numpy scipy pandas matplotlib'
      custom_requirements:
        description: 'æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰requirements.txt'
        type: boolean
        default: false

jobs:
  build-packages:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # å…è®¸éƒ¨åˆ†å¤±è´¥
      matrix:
        include:
          # Windows x86-64 (ä½¿ç”¨2019æé«˜å…¼å®¹æ€§)
          - os: windows-2019
            python-version: '3.8'
            platform: windows
            arch: x86_64
          - os: windows-2019
            python-version: '3.9'
            platform: windows
            arch: x86_64
          - os: windows-2019
            python-version: '3.10'
            platform: windows
            arch: x86_64
          - os: windows-2019
            python-version: '3.11'
            platform: windows
            arch: x86_64
          - os: windows-2019
            python-version: '3.12'
            platform: windows
            arch: x86_64
          
          # Linux x86-64
          - os: ubuntu-22.04
            python-version: '3.8'
            platform: linux
            arch: x86_64
          - os: ubuntu-22.04
            python-version: '3.9'
            platform: linux
            arch: x86_64
          - os: ubuntu-22.04
            python-version: '3.10'
            platform: linux
            arch: x86_64
          - os: ubuntu-22.04
            python-version: '3.11'
            platform: linux
            arch: x86_64
          - os: ubuntu-22.04
            python-version: '3.12'
            platform: linux
            arch: x86_64
          
          # Linux ARM64 (åŽŸç”ŸARM64çŽ¯å¢ƒ)
          - os: ubuntu-22.04-arm
            python-version: '3.8'
            platform: linux
            arch: aarch64
          - os: ubuntu-22.04-arm
            python-version: '3.9'
            platform: linux
            arch: aarch64
          - os: ubuntu-22.04-arm
            python-version: '3.10'
            platform: linux
            arch: aarch64
          - os: ubuntu-22.04-arm
            python-version: '3.11'
            platform: linux
            arch: aarch64
          - os: ubuntu-22.04-arm
            python-version: '3.12'
            platform: linux
            arch: aarch64
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.arch == 'aarch64' && 'arm64' || 'x64' }}
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-${{ matrix.arch }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.arch }}-pip-
    
    - name: Verify native architecture
      shell: bash
      run: |
        echo "Runner OS: ${{ runner.os }}"
        echo "Matrix OS: ${{ matrix.os }}"
        echo "Current architecture: $(uname -m)"
        echo "Python platform: $(python -c 'import platform; print(platform.machine())')"
        echo "Expected architecture: ${{ matrix.arch }}"
        echo "Python version: $(python --version)"
    
    - name: Get platform info
      id: platform
      shell: bash
      run: |
        case "${{ matrix.arch }}" in
          "x86_64")
            if [[ "${{ matrix.platform }}" == "windows" ]]; then
              echo "platform=win_amd64" >> $GITHUB_OUTPUT
            else
              echo "platform=linux_x86_64" >> $GITHUB_OUTPUT
            fi
            ;;
          "aarch64")
            echo "platform=linux_aarch64" >> $GITHUB_OUTPUT
            ;;
        esac
        
        # è®¾ç½®è¾“å‡ºç›®å½•å
        py_version=$(echo "${{ matrix.python-version }}" | tr -d '.')
        echo "output_dir=packages-${{ matrix.platform }}-${{ matrix.arch }}-py${py_version}" >> $GITHUB_OUTPUT
        
        echo "Platform tag: $platform"
        echo "Output directory: packages-${{ matrix.platform }}-${{ matrix.arch }}-py${py_version}"
    
    - name: Upgrade pip and install tools
      shell: bash
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install pip-tools || echo "pip-toolså®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡ç‰ˆæœ¬é”å®š"
    
    - name: Prepare package list
      id: packages
      shell: bash
      run: |
        if [[ "${{ github.event.inputs.custom_requirements }}" == "true" && -f "requirements.txt" ]]; then
          echo "ä½¿ç”¨é¡¹ç›®ä¸­çš„requirements.txt"
          cp requirements.txt temp_requirements.txt
        else
          # ä½¿ç”¨è¾“å…¥çš„åŒ…åˆ—è¡¨æˆ–é»˜è®¤åŒ…
          PACKAGES="${{ github.event.inputs.packages }}"
          if [[ -z "$PACKAGES" ]]; then
            PACKAGES="numpy scipy pandas matplotlib seaborn scikit-learn requests urllib3 setuptools wheel pip"
          fi
          echo "ä½¿ç”¨åŒ…åˆ—è¡¨: $PACKAGES"
          echo "$PACKAGES" | tr ' ' '\n' > temp_requirements.txt
        fi
        
        echo "åŸºç¡€åŒ…åˆ—è¡¨:"
        cat temp_requirements.txt
        
        # ç”Ÿæˆè¯¦ç»†çš„requirements.txtï¼ˆåŒ…å«ç‰ˆæœ¬é”å®šï¼‰
        if command -v pip-compile >/dev/null 2>&1; then
          echo "æ­£åœ¨ç”Ÿæˆé”å®šç‰ˆæœ¬çš„requirements..."
          if pip-compile temp_requirements.txt --output-file=requirements_locked.txt --no-emit-index-url; then
            echo "pip-compileæˆåŠŸ"
          else
            echo "pip-compileå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€åŒ…åˆ—è¡¨"
            cp temp_requirements.txt requirements_locked.txt
          fi
        else
          echo "pip-toolsä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€åŒ…åˆ—è¡¨"
          cp temp_requirements.txt requirements_locked.txt
        fi
        
        echo "æœ€ç»ˆçš„requirementsæ–‡ä»¶å†…å®¹:"
        cat requirements_locked.txt
    
    - name: Download packages
      shell: bash
      run: |
        mkdir -p ${{ steps.platform.outputs.output_dir }}
        mkdir -p ${{ steps.platform.outputs.output_dir }}/with_deps
        
        echo "å¼€å§‹ä¸‹è½½ ${{ matrix.platform }}-${{ matrix.arch }} å¹³å°çš„åŒ…..."
        echo "Platform tag: ${{ steps.platform.outputs.platform }}"
        echo "Python version: ${{ matrix.python-version }}"
        
        # é¦–å…ˆä¸‹è½½åŒ…å«æ‰€æœ‰ä¾èµ–çš„ç‰ˆæœ¬ï¼ˆé€šç”¨ï¼‰
        echo "=== ä¸‹è½½åŒ…å«ä¾èµ–çš„é€šç”¨ç‰ˆæœ¬ ==="
        pip download \
          -r requirements_locked.txt \
          --dest ${{ steps.platform.outputs.output_dir }}/with_deps \
          --prefer-binary \
          --python-version ${{ matrix.python-version }} || {
            echo "é€šç”¨ç‰ˆæœ¬ä¸‹è½½å¤±è´¥ï¼Œä½†ç»§ç»­è¿›è¡Œ..."
          }
        
        # ç„¶åŽä¸‹è½½ç‰¹å®šå¹³å°çš„wheelåŒ…
        echo "=== ä¸‹è½½ç‰¹å®šå¹³å°çš„wheelåŒ… ==="
        pip download \
          -r requirements_locked.txt \
          --dest ${{ steps.platform.outputs.output_dir }} \
          --platform ${{ steps.platform.outputs.platform }} \
          --python-version ${{ matrix.python-version }} \
          --only-binary=:all: \
          --no-deps || {
            echo "ç‰¹å®šå¹³å°ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ›´å®½æ¾çš„ç­–ç•¥..."
            pip download \
              -r requirements_locked.txt \
              --dest ${{ steps.platform.outputs.output_dir }} \
              --prefer-binary \
              --python-version ${{ matrix.python-version }} \
              --no-deps || {
                echo "å®½æ¾ç­–ç•¥ä¹Ÿå¤±è´¥ï¼Œå°è¯•æœ€åŸºæœ¬çš„ä¸‹è½½..."
                pip download \
                  -r requirements_locked.txt \
                  --dest ${{ steps.platform.outputs.output_dir }} \
                  --no-deps
              }
          }
    
    - name: Create installation script
      shell: bash
      run: |
        # Linux/Macå®‰è£…è„šæœ¬
        cat > ${{ steps.platform.outputs.output_dir }}/install.sh << 'EOF'
        #!/bin/bash
        # ç¦»çº¿å®‰è£…è„šæœ¬ - Linux/Mac
        
        set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º
        
        echo "======================================"
        echo "PythonåŒ…ç¦»çº¿å®‰è£…è„šæœ¬"
        echo "======================================"
        echo "å¹³å°: ${{ steps.platform.outputs.platform }}"
        echo "Pythonç‰ˆæœ¬: ${{ matrix.python-version }}"
        echo "æž¶æž„: ${{ matrix.arch }}"
        echo "æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "æœªçŸ¥")"
        echo "======================================"
        
        # æ£€æŸ¥Pythonæ˜¯å¦å¯ç”¨
        if ! command -v python3 >/dev/null 2>&1 && ! command -v python >/dev/null 2>&1; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°Pythonè§£é‡Šå™¨"
          exit 1
        fi
        
        # ä½¿ç”¨python3æˆ–python
        PYTHON_CMD="python3"
        if ! command -v python3 >/dev/null 2>&1; then
          PYTHON_CMD="python"
        fi
        
        echo "ä½¿ç”¨Pythonè§£é‡Šå™¨: $PYTHON_CMD"
        
        # æ£€æŸ¥Pythonç‰ˆæœ¬
        PYTHON_VERSION=$($PYTHON_CMD --version 2>&1 | grep -oP '(?<=Python )\d+\.\d+' || echo "unknown")
        echo "å½“å‰Pythonç‰ˆæœ¬: $PYTHON_VERSION"
        echo "åŒ…æž„å»ºç‰ˆæœ¬: ${{ matrix.python-version }}"
        
        if [[ "$PYTHON_VERSION" != "${{ matrix.python-version }}" ]]; then
          echo "âš ï¸  è­¦å‘Š: Pythonç‰ˆæœ¬ä¸åŒ¹é…ï¼"
          echo "   å½“å‰ç‰ˆæœ¬: $PYTHON_VERSION"
          echo "   åŒ…ç‰ˆæœ¬:   ${{ matrix.python-version }}"
          echo ""
          read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/N): " confirm
          if [[ $confirm != [yY] && $confirm != [yY][eE][sS] ]]; then
            echo "å®‰è£…å·²å–æ¶ˆ"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥requirementsæ–‡ä»¶
        if [[ ! -f "requirements_locked.txt" ]]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°requirements_locked.txtæ–‡ä»¶"
          echo "è¯·ç¡®ä¿åœ¨åŒ…å«å®‰è£…æ–‡ä»¶çš„ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
          exit 1
        fi
        
        echo ""
        echo "å¼€å§‹å®‰è£…åŒ…..."
        echo "======================================"
        
        # å®‰è£…åŒ…
        $PYTHON_CMD -m pip install --no-index --find-links . -r requirements_locked.txt
        
        if [[ $? -eq 0 ]]; then
          echo "======================================"
          echo "âœ… å®‰è£…å®Œæˆï¼"
          echo ""
          echo "éªŒè¯å®‰è£…:"
          $PYTHON_CMD -c "
        try:
            import numpy, scipy, pandas, matplotlib
            print('âœ… ä¸»è¦åŒ…å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print('âš ï¸  éƒ¨åˆ†åŒ…å¯¼å…¥å¤±è´¥:', e)
        "
        else
          echo "âŒ å®‰è£…å¤±è´¥ï¼"
          echo "å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·å°è¯•ï¼š"
          echo "1. ä½¿ç”¨with_depsç›®å½•ä¸­çš„åŒ…"
          echo "2. æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§"
          echo "3. å®‰è£…ç³»ç»Ÿçº§ä¾èµ–"
          exit 1
        fi
        EOF
        
        # Windowsæ‰¹å¤„ç†è„šæœ¬
        cat > ${{ steps.platform.outputs.output_dir }}/install.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ======================================
        echo PythonåŒ…ç¦»çº¿å®‰è£…è„šæœ¬ - Windows
        echo ======================================
        echo å¹³å°: ${{ steps.platform.outputs.platform }}
        echo Pythonç‰ˆæœ¬: ${{ matrix.python-version }}
        echo æž¶æž„: ${{ matrix.arch }}
        echo ======================================
        
        REM æ£€æŸ¥Pythonæ˜¯å¦å¯ç”¨
        python --version >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
            echo âŒ é”™è¯¯: æœªæ‰¾åˆ°Pythonè§£é‡Šå™¨
            echo è¯·ç¡®ä¿Pythonå·²å®‰è£…å¹¶æ·»åŠ åˆ°PATHçŽ¯å¢ƒå˜é‡
            pause
            exit /b 1
        )
        
        echo å½“å‰Pythonç‰ˆæœ¬:
        python --version
        
        REM æ£€æŸ¥requirementsæ–‡ä»¶
        if not exist "requirements_locked.txt" (
            echo âŒ é”™è¯¯: æœªæ‰¾åˆ°requirements_locked.txtæ–‡ä»¶
            echo è¯·ç¡®ä¿åœ¨åŒ…å«å®‰è£…æ–‡ä»¶çš„ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬
            pause
            exit /b 1
        )
        
        echo.
        echo å¼€å§‹å®‰è£…åŒ…...
        echo ======================================
        
        REM å®‰è£…åŒ…
        python -m pip install --no-index --find-links . -r requirements_locked.txt
        
        if %ERRORLEVEL% EQU 0 (
            echo ======================================
            echo âœ… å®‰è£…å®Œæˆï¼
            echo.
            echo éªŒè¯å®‰è£…:
            python -c "try: import numpy, scipy, pandas, matplotlib; print('âœ… ä¸»è¦åŒ…å¯¼å…¥æˆåŠŸ'); except ImportError as e: print('âš ï¸ éƒ¨åˆ†åŒ…å¯¼å…¥å¤±è´¥:', e)"
        ) else (
            echo âŒ å®‰è£…å¤±è´¥ï¼
            echo å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·å°è¯•ï¼š
            echo 1. ä½¿ç”¨with_depsç›®å½•ä¸­çš„åŒ…
            echo 2. æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§
            echo 3. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
        )
        
        echo.
        pause
        EOF
        
        # PowerShellè„šæœ¬
        cat > ${{ steps.platform.outputs.output_dir }}/install.ps1 << 'EOF'
        # PowerShellå®‰è£…è„šæœ¬
        
        Write-Host "======================================" -ForegroundColor Green
        Write-Host "PythonåŒ…ç¦»çº¿å®‰è£…è„šæœ¬ - PowerShell" -ForegroundColor Green
        Write-Host "======================================" -ForegroundColor Green
        Write-Host "å¹³å°: ${{ steps.platform.outputs.platform }}"
        Write-Host "Pythonç‰ˆæœ¬: ${{ matrix.python-version }}"
        Write-Host "æž¶æž„: ${{ matrix.arch }}"
        Write-Host "======================================" -ForegroundColor Green
        
        # æ£€æŸ¥Python
        try {
            $pythonVersion = python --version 2>&1
            Write-Host "å½“å‰Pythonç‰ˆæœ¬: $pythonVersion"
        } catch {
            Write-Host "âŒ é”™è¯¯: æœªæ‰¾åˆ°Pythonè§£é‡Šå™¨" -ForegroundColor Red
            Read-Host "æŒ‰ä»»æ„é”®é€€å‡º"
            exit 1
        }
        
        # æ£€æŸ¥requirementsæ–‡ä»¶
        if (-not (Test-Path "requirements_locked.txt")) {
            Write-Host "âŒ é”™è¯¯: æœªæ‰¾åˆ°requirements_locked.txtæ–‡ä»¶" -ForegroundColor Red
            Read-Host "æŒ‰ä»»æ„é”®é€€å‡º"
            exit 1
        }
        
        Write-Host ""
        Write-Host "å¼€å§‹å®‰è£…åŒ…..." -ForegroundColor Yellow
        Write-Host "======================================" -ForegroundColor Green
        
        # å®‰è£…åŒ…
        python -m pip install --no-index --find-links . -r requirements_locked.txt
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "======================================" -ForegroundColor Green
            Write-Host "âœ… å®‰è£…å®Œæˆï¼" -ForegroundColor Green
            Write-Host ""
            Write-Host "éªŒè¯å®‰è£…:" -ForegroundColor Yellow
            python -c "try: import numpy, scipy, pandas, matplotlib; print('âœ… ä¸»è¦åŒ…å¯¼å…¥æˆåŠŸ'); except ImportError as e: print('âš ï¸ éƒ¨åˆ†åŒ…å¯¼å…¥å¤±è´¥:', e)"
        } else {
            Write-Host "âŒ å®‰è£…å¤±è´¥ï¼" -ForegroundColor Red
            Write-Host "å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·å°è¯•ï¼š" -ForegroundColor Yellow
            Write-Host "1. ä½¿ç”¨with_depsç›®å½•ä¸­çš„åŒ…"
            Write-Host "2. æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§"
            Write-Host "3. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒPowerShell"
        }
        
        Read-Host "æŒ‰ä»»æ„é”®é€€å‡º"
        EOF
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        chmod +x ${{ steps.platform.outputs.output_dir }}/install.sh 2>/dev/null || true
    
    - name: Create README
      shell: bash
      run: |
        cat > ${{ steps.platform.outputs.output_dir }}/README.md << EOF
        # PythonåŒ…ç¦»çº¿å®‰è£…åŒ…
        
        ## ðŸ“‹ çŽ¯å¢ƒä¿¡æ¯
        - **æ“ä½œç³»ç»Ÿ**: ${{ matrix.os }}
        - **Pythonç‰ˆæœ¬**: ${{ matrix.python-version }}
        - **æž¶æž„**: ${{ matrix.arch }}
        - **å¹³å°æ ‡ç­¾**: ${{ steps.platform.outputs.platform }}
        - **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **GitHub Actions Run**: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ## ðŸ“¦ åŒ…å«çš„åŒ…
        \`\`\`
        $(cat requirements_locked.txt)
        \`\`\`
        
        ## ðŸš€ å®‰è£…æ–¹æ³•
        
        ### æ–¹æ³•1: ä½¿ç”¨å®‰è£…è„šæœ¬ï¼ˆæŽ¨èï¼‰
        
        **Linux/Mac:**
        \`\`\`bash
        chmod +x install.sh
        ./install.sh
        \`\`\`
        
        **Windows CMD:**
        \`\`\`cmd
        install.bat
        \`\`\`
        
        **Windows PowerShell:**
        \`\`\`powershell
        Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
        .\install.ps1
        \`\`\`
        
        ### æ–¹æ³•2: æ‰‹åŠ¨å®‰è£…
        \`\`\`bash
        # å®‰è£…æŒ‡å®šçš„åŒ…ï¼ˆä¸åŒ…å«ä¾èµ–ï¼‰
        pip install --no-index --find-links . -r requirements_locked.txt
        
        # æˆ–è€…å®‰è£…åŒ…å«å®Œæ•´ä¾èµ–çš„ç‰ˆæœ¬
        pip install --no-index --find-links ./with_deps -r requirements_locked.txt
        \`\`\`
        
        ### æ–¹æ³•3: å®‰è£…å•ä¸ªåŒ…
        \`\`\`bash
        # æŸ¥çœ‹å¯ç”¨çš„åŒ…
        ls *.whl
        
        # å®‰è£…å•ä¸ªåŒ…
        pip install --no-index --find-links . åŒ…å
        \`\`\`
        
        ## âœ… éªŒè¯å®‰è£…
        \`\`\`python
        # éªŒè¯ä¸»è¦åŒ…
        import numpy as np
        import scipy
        import pandas as pd
        import matplotlib.pyplot as plt
        
        print("NumPyç‰ˆæœ¬:", np.__version__)
        print("SciPyç‰ˆæœ¬:", scipy.__version__)
        print("Pandasç‰ˆæœ¬:", pd.__version__)
        print("âœ… æ‰€æœ‰ä¸»è¦åŒ…å®‰è£…æˆåŠŸï¼")
        \`\`\`
        
        ## ðŸ“ ç›®å½•ç»“æž„
        \`\`\`
        ${{ steps.platform.outputs.output_dir }}/
        â”œâ”€â”€ *.whl                    # ç‰¹å®šå¹³å°çš„wheelåŒ…
        â”œâ”€â”€ with_deps/               # åŒ…å«å®Œæ•´ä¾èµ–çš„åŒ…
        â”‚   â””â”€â”€ *.whl
        â”œâ”€â”€ requirements_locked.txt  # é”å®šç‰ˆæœ¬çš„ä¾èµ–æ–‡ä»¶
        â”œâ”€â”€ install.sh              # Linux/Macå®‰è£…è„šæœ¬
        â”œâ”€â”€ install.bat             # Windowsæ‰¹å¤„ç†è„šæœ¬
        â”œâ”€â”€ install.ps1             # PowerShellè„šæœ¬
        â””â”€â”€ README.md               # æœ¬è¯´æ˜Žæ–‡ä»¶
        \`\`\`
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        
        ### ç³»ç»Ÿè¦æ±‚
        - **Pythonç‰ˆæœ¬**: ${{ matrix.python-version }} (æŽ¨èä½¿ç”¨å®Œå…¨ç›¸åŒçš„ç‰ˆæœ¬)
        - **æž¶æž„**: ${{ matrix.arch }}
        - **æ“ä½œç³»ç»Ÿ**: ${{ matrix.platform }}
        
        ### å…¼å®¹æ€§è¯´æ˜Ž
        1. **Pythonç‰ˆæœ¬**: å»ºè®®ä½¿ç”¨ä¸Žæž„å»ºæ—¶ç›¸åŒçš„Pythonç‰ˆæœ¬ (${{ matrix.python-version }})
        2. **ç³»ç»Ÿæž¶æž„**: åŒ…å·²é’ˆå¯¹ ${{ matrix.arch }} æž¶æž„ä¼˜åŒ–
        3. **æ“ä½œç³»ç»Ÿ**: 
           - WindowsåŒ…å…¼å®¹ Windows 10+ / Windows Server 2016+
           - LinuxåŒ…åŸºäºŽUbuntu 22.04æž„å»ºï¼Œå…¼å®¹å¤§å¤šæ•°çŽ°ä»£Linuxå‘è¡Œç‰ˆ
        
        ### æ•…éšœæŽ’é™¤
        
        **é—®é¢˜1: åŒ…ç‰ˆæœ¬å†²çª**
        \`\`\`bash
        # è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è™šæ‹ŸçŽ¯å¢ƒ
        python -m venv myenv
        source myenv/bin/activate  # Linux/Mac
        # æˆ–
        myenv\Scripts\activate     # Windows
        
        # ç„¶åŽè¿è¡Œå®‰è£…è„šæœ¬
        \`\`\`
        
        **é—®é¢˜2: ä¾èµ–ç¼ºå¤±**
        \`\`\`bash
        # è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨with_depsç›®å½•
        pip install --no-index --find-links ./with_deps -r requirements_locked.txt
        \`\`\`
        
        **é—®é¢˜3: æƒé™é—®é¢˜ (Linux/Mac)**
        \`\`\`bash
        # è§£å†³æ–¹æ¡ˆï¼šç”¨æˆ·çº§å®‰è£…
        pip install --user --no-index --find-links . -r requirements_locked.txt
        \`\`\`
        
        **é—®é¢˜4: ç³»ç»Ÿçº§ä¾èµ–ç¼ºå¤±**
        
        æŸäº›åŒ…å¯èƒ½éœ€è¦ç³»ç»Ÿçº§åº“ï¼š
        
        *Ubuntu/Debian:*
        \`\`\`bash
        sudo apt-get update
        sudo apt-get install build-essential python3-dev
        \`\`\`
        
        *CentOS/RHEL:*
        \`\`\`bash
        sudo yum groupinstall "Development Tools"
        sudo yum install python3-devel
        \`\`\`
        
        *Windows:*
        - å®‰è£… Microsoft Visual C++ Redistributable
        - æŸäº›åŒ…å¯èƒ½éœ€è¦ Microsoft Visual Studio Build Tools
        
        ## ðŸ“ž æ”¯æŒ
        
        å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
        1. Pythonç‰ˆæœ¬æ˜¯å¦åŒ¹é…
        2. ç³»ç»Ÿæž¶æž„æ˜¯å¦æ­£ç¡®
        3. æ˜¯å¦æœ‰å¿…è¦çš„ç³»ç»Ÿçº§ä¾èµ–
        4. å°è¯•ä½¿ç”¨è™šæ‹ŸçŽ¯å¢ƒéš”ç¦»å®‰è£…
        
        æž„å»ºä¿¡æ¯ï¼š
        - Repository: ${{ github.repository }}
        - Commit: ${{ github.sha }}
        - Workflow: ${{ github.workflow }}
        
        ---
        *è¯¥åŒ…ç”± GitHub Actions è‡ªåŠ¨æž„å»ºç”Ÿæˆ*
        EOF
        
        # å¤åˆ¶requirementsæ–‡ä»¶
        cp requirements_locked.txt ${{ steps.platform.outputs.output_dir }}/
        
        # å¦‚æžœå­˜åœ¨åŽŸå§‹requirementsæ–‡ä»¶ï¼Œä¹Ÿå¤åˆ¶ä¸€ä»½
        if [[ -f "temp_requirements.txt" ]]; then
          cp temp_requirements.txt ${{ steps.platform.outputs.output_dir }}/requirements_original.txt
        fi
    
    - name: Verify downloaded packages
      shell: bash
      run: |
        echo "======================================"
        echo "ä¸‹è½½éªŒè¯æŠ¥å‘Š"
        echo "======================================"
        echo "å¹³å°: ${{ matrix.platform }}-${{ matrix.arch }}"
        echo "Python: ${{ matrix.python-version }}"
        echo "ç›®å½•: ${{ steps.platform.outputs.output_dir }}"
        echo ""
        
        echo "ä¸»ç›®å½•æ–‡ä»¶:"
        ls -la ${{ steps.platform.outputs.output_dir }}/ || echo "æ— æ³•åˆ—å‡ºæ–‡ä»¶"
        echo ""
        
        echo "ä¾èµ–ç›®å½•æ–‡ä»¶:"
        ls -la ${{ steps.platform.outputs.output_dir }}/with_deps/ || echo "ä¾èµ–ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        echo ""
        
        echo "ç»Ÿè®¡ä¿¡æ¯:"
        MAIN_COUNT=$(find ${{ steps.platform.outputs.output_dir }}/ -maxdepth 1 -name "*.whl" | wc -l || echo "0")
        DEPS_COUNT=$(find ${{ steps.platform.outputs.output_dir }}/with_deps/ -name "*.whl" 2>/dev/null | wc -l || echo "0")
        echo "ä¸»ç›®å½•wheelåŒ…æ•°é‡: $MAIN_COUNT"
        echo "ä¾èµ–ç›®å½•wheelåŒ…æ•°é‡: $DEPS_COUNT"
        echo "æ€»è®¡: $((MAIN_COUNT + DEPS_COUNT))"
        
        echo ""
        echo "åŒ…æ–‡ä»¶ç¤ºä¾‹:"
        find ${{ steps.platform.outputs.output_dir }}/ -name "*.whl" | head -5 || echo "æœªæ‰¾åˆ°wheelæ–‡ä»¶"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•åŒ…
        if [[ $MAIN_COUNT -eq 0 && $DEPS_COUNT -eq 0 ]]; then
          echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•wheelåŒ…æ–‡ä»¶"
        else
          echo "âœ… åŒ…ä¸‹è½½éªŒè¯é€šè¿‡"
        fi
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.platform.outputs.output_dir }}
        path: ${{ steps.platform.outputs.output_dir }}/
        retention-days: 30
        compression-level: 6
        if-no-files-found: warn
    
    - name: Create release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.platform.outputs.output_dir }}/*.whl
          ${{ steps.platform.outputs.output_dir }}/requirements_locked.txt
          ${{ steps.platform.outputs.output_dir }}/README.md
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        body: |
          # PythonåŒ…ç¦»çº¿å®‰è£…åŒ… - ${{ github.ref_name }}
          
          æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹å¹³å°çš„PythonåŒ…ï¼š
          
          ## æ”¯æŒçš„çŽ¯å¢ƒ
          - **Windows x86-64**: Python 3.8-3.12
          - **Linux x86-64**: Python 3.8-3.12  
          - **Linux ARM64**: Python 3.8-3.12
          
          ## ä¸‹è½½è¯´æ˜Ž
          è¯·æ ¹æ®æ‚¨çš„çŽ¯å¢ƒä¸‹è½½å¯¹åº”çš„artifactåŒ…ï¼Œè§£åŽ‹åŽæŒ‰ç…§README.mdä¸­çš„è¯´æ˜Žè¿›è¡Œå®‰è£…ã€‚
          
          æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          æäº¤: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-summary:
    needs: build-packages
    runs-on: ubuntu-latest
    if: always()  # å³ä½¿æœ‰jobå¤±è´¥ä¹Ÿè¿è¡Œ
    steps:
    - name: Create build summary
      run: |
        echo "# ðŸš€ PythonåŒ…æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æœ¬æ¬¡æž„å»ºä¸ºä»¥ä¸‹çŽ¯å¢ƒåˆ›å»ºäº†ç¦»çº¿å®‰è£…åŒ…ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š æž„å»ºçŸ©é˜µ" >> $GITHUB_STEP_SUMMARY
        echo "| æ“ä½œç³»ç»Ÿ | Pythonç‰ˆæœ¬ | æž¶æž„ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|------------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows 2019 | 3.8-3.12 | x86_64 | ${{ needs.build-packages.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Ubuntu 22.04 | 3.8-3.12 | x86_64 | ${{ needs.build-packages.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Ubuntu 22.04 ARM | 3.8-3.12 | aarch64 | ${{ needs.build-packages.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ æ”¯æŒçš„å¹³å°" >> $GITHUB_STEP_SUMMARY
        echo "- **Windows x86-64**: å®Œæ•´æ”¯æŒPython 3.8-3.12ï¼Œå…¼å®¹Windows 10+/Server 2016+" >> $GITHUB_STEP_SUMMARY
        echo "- **Linux x86-64**: å®Œæ•´æ”¯æŒPython 3.8-3.12ï¼ŒåŸºäºŽUbuntu 22.04æž„å»º" >> $GITHUB_STEP_SUMMARY
        echo "- **Linux ARM64**: å®Œæ•´æ”¯æŒPython 3.8-3.12ï¼ŒåŽŸç”ŸARM64çŽ¯å¢ƒæž„å»º" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "æ‰€æœ‰æž„å»ºäº§ç‰©å¯åœ¨Actionsé¡µé¢çš„ **Artifacts** éƒ¨åˆ†ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— å¿«é€Ÿé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æœ¬æ¬¡è¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [å·¥ä½œæµæºç ](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/build-packages.yml)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ ä½¿ç”¨è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„artifactåŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "2. è§£åŽ‹åˆ°ç›®æ ‡æœºå™¨" >> $GITHUB_STEP_SUMMARY
        echo "3. è¿è¡Œå®‰è£…è„šæœ¬æˆ–æŸ¥çœ‹README.mdèŽ·å–è¯¦ç»†è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> $GITHUB_STEP_SUMMARY
